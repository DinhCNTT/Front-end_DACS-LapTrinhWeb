import { useState, useEffect } from "react";
import axios from "axios";
import { ToastContainer, toast } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";
import "./ManageParentCategories.css";

const ManageParentCategories = () => {
    const [categories, setCategories] = useState([]);
    const [editingCategory, setEditingCategory] = useState(null);
    const [newName, setNewName] = useState("");
    const [newImage, setNewImage] = useState(null);
    const [newIcon, setNewIcon] = useState(null);
    const [previewImage, setPreviewImage] = useState("");
    const [previewIcon, setPreviewIcon] = useState("");

    useEffect(() => {
        fetchCategories();
    }, []);

    const fetchCategories = async () => {
        try {
            const res = await axios.get("http://localhost:5133/api/admin/get-parent-categories");
            setCategories(res.data);
        } catch (error) {
            console.error("L·ªói khi l·∫•y danh m·ª•c cha:", error);
            toast.error("L·ªói khi t·∫£i danh s√°ch danh m·ª•c cha");
        }
    };

    const handleEdit = (category) => {
        setEditingCategory(category);
        setNewName(category.tenDanhMucCha);
        setPreviewImage(category.anhDanhMuc ? `http://localhost:5133/${category.anhDanhMuc}` : "");
        setPreviewIcon(category.icon ? `http://localhost:5133/${category.icon}` : "");
    };

    const handleImageChange = (e) => {
        const file = e.target.files[0];
        setNewImage(file);
        setPreviewImage(URL.createObjectURL(file));
    };

    const handleIconChange = (e) => {
        const file = e.target.files[0];
        setNewIcon(file);
        setPreviewIcon(URL.createObjectURL(file));
    };

    const handleUpdate = async () => {
        if (!newName.trim()) {
            toast.error("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!");
            return;
        }
    
        const formData = new FormData();
        formData.append("tenDanhMucCha", newName);
        if (newImage) formData.append("anhDanhMuc", newImage);
        if (newIcon) formData.append("icon", newIcon);
    
        try {
            const response = await axios.put(
                `http://localhost:5133/api/admin/update-parent-category/${editingCategory.maDanhMucCha}`,
                formData,
                {
                    headers: {
                        "Content-Type": "multipart/form-data",
                        "Authorization": `Bearer ${localStorage.getItem("token")}` // Th√™m token n·∫øu c·∫ßn
                    }
                }
            );
            console.log("Response:", response.data); // Debug
            toast.success("C·∫≠p nh·∫≠t danh m·ª•c cha th√†nh c√¥ng!"); // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            fetchCategories(); // G·ªçi l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch danh m·ª•c
        } catch (error) {
            console.error("Chi ti·∫øt l·ªói:", {
                message: error.message,
                response: error.response?.data
            });
            toast.error(error.response?.data?.message || "L·ªói khi c·∫≠p nh·∫≠t");
        }
    };

    const handleDelete = async (id) => {
        if (!window.confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh m·ª•c n√†y?")) return;
    
        try {
            await axios.delete(`http://localhost:5133/api/admin/delete-parent-category/${id}`);
            toast.success("X√≥a danh m·ª•c cha th√†nh c√¥ng!");
            fetchCategories();
        } catch (error) {
            console.error("L·ªói khi x√≥a:", error);
            // Ki·ªÉm tra xem ph·∫£n h·ªìi c√≥ t·ªìn t·∫°i kh√¥ng
            if (error.response) {
                console.log("Ph·∫£n h·ªìi t·ª´ API:", error.response.data); // Debug
                toast.error(error.response.data.message || "L·ªói khi x√≥a danh m·ª•c cha!");
            } else {
                toast.error("L·ªói kh√¥ng x√°c ƒë·ªãnh!");
            }
        }
    };

    return (
        <div className="parent-category-page-container">
            <h2>Qu·∫£n L√Ω Danh M·ª•c Cha</h2>
            <ToastContainer autoClose={3000} />

            <table className="parent-category-table">
                <thead>
                    <tr>
                        <th>M√£ DM</th>
                        <th>T√™n Danh M·ª•c</th>
                        <th>·∫¢nh</th>
                        <th>Icon</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {categories.map((cat) => (
                        <tr key={cat.maDanhMucCha}>
                            <td>{cat.maDanhMucCha}</td>
                            <td>
                                {editingCategory?.maDanhMucCha === cat.maDanhMucCha ? (
                                    <input
                                        type="text"
                                        value={newName}
                                        onChange={(e) => setNewName(e.target.value)}
                                        className="edit-input"
                                    />
                                ) : (
                                    cat.tenDanhMucCha
                                )}
                            </td>
                            <td>
                                {editingCategory?.maDanhMucCha === cat.maDanhMucCha ? (
                                    <div className="file-upload">
                                        <input type="file" onChange={handleImageChange} />
                                        {previewImage && (
                                            <img src={previewImage} alt="Preview" className="image-preview" />
                                        )}
                                    </div>
                                ) : (
                                    cat.anhDanhMuc && (
                                        <img 
                                            src={`http://localhost:5133/${cat.anhDanhMuc}`} 
                                            alt="·∫¢nh DM" 
                                            className="category-image" 
                                        />
                                    )
                                )}
                            </td>
                            <td>
                                {editingCategory?.maDanhMucCha === cat.maDanhMucCha ? (
                                    <div className="file-upload">
                                        <input type="file" onChange={handleIconChange} />
                                        {previewIcon && (
                                            <img src={previewIcon} alt="Icon Preview" className="icon-preview" />
                                        )}
                                    </div>
                                ) : (
                                    cat.icon && (
                                        <img 
                                            src={`http://localhost:5133/${cat.icon}`} 
                                            alt="Icon DM" 
                                            className="category-icon" 
                                        />
                                    )
                                )}
                            </td>
                            <td>
                                {editingCategory?.maDanhMucCha === cat.maDanhMucCha ? (
                                    <>
                                        <button className="save-btn" onClick={handleUpdate}>
                                            üíæ L∆∞u
                                        </button>
                                        <button className="cancel-btn" onClick={() => setEditingCategory(null)}>
                                            ‚ùå H·ªßy
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button className="edit-btn" onClick={() => handleEdit(cat)}>
                                            ‚úèÔ∏è S·ª≠a
                                        </button>
                                        <button className="delete-btn" onClick={() => handleDelete(cat.maDanhMucCha)}>
                                            üóëÔ∏è X√≥a
                                        </button>
                                    </>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
};

export default ManageParentCategories;